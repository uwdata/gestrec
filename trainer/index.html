<!DOCTYPE HTML>
<html>
  <head>
    <title>Protractor Gesture Designer</title>
    <link rel="stylesheet" type="text/css" href="library.css">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="../protractor.min.js" charset="utf-8"></script>
    <script src="library.js" charset="utf-8"></script>
    <style>
body {
  font-family: Helvetica Neue;
  padding: 0;
  margin: 0;
  padding-top: 10px;
  margin-bottom: 10px;
  margin-right: 10px;
}
#designer {
  position: fixed;
  top: 0;
  left: 0;
  padding-top: 10px;
  padding-left: 10px;
  padding-right: 10px;
  width: 400px;
}
#designer .controls {
  margin-bottom: 4px;
}
#designer .controls label {
  font-size: 13px;
  margin-right: 4px;
}
canvas {
  background: #f5f5f5;
  border: 1px solid #dedede;
}
#panel {
  margin-left: 430px;
  padding-bottom: 20px;
  padding-right: 10px;
}
#export {
  position: relative;
}
#export .header {
  margin-bottom: 9px;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 2px;
}
#export textarea {
  width: 100%;
  height: 600px;
  border: 1px solid #dedede;
}
#export .controls {
  position: absolute;
  right: 5px;
  top: -2px;
}
    </style>
  </head>
  <body>
    <div id="designer">
      <div class="controls">
        Mode: 
        <label><input type="radio" name="mode" value="train" checked>Train</label>
        <label><input type="radio" name="mode" value="test">Test</label>
        <label><input type="radio" name="mode" value="export">Import/Export</label>
      </div>
      <canvas id="canvas" width="400" height="400"></canvas>
      <br/>
      <div id="message"></div>
    </div>
    <div id="panel">
      <div id="library"></div>
      <div id="export" style="display: none;">
        <div class="header">
          Gesture Loader
          <div class="controls">
            <button id="download">Download</button>
            <button id="import">Import</button>
          </div>
        </div>
        <textarea id="json"></textarea>
      </div>
    </div>
  </body>
  <script>
var THRESHOLD = 2;
var mode = "";

setMode("train");

function setMode(value) {
  mode = value;
  d3.select(".controls input[value='"+mode+"']").property("checked", true);
  if (mode === "export") {
    d3.select("#library").style("display", "none");
    d3.select("#export").style("display", "block");
    d3.select("#json").property("value", lib.toJSON());
  } else {
    d3.select("#library").style("display", "block");
    d3.select("#export").style("display", "none");
  }
  d3.select("#canvas")
    .style("border", mode==="train" ? "1px dashed #a33" : null);
}

d3.selectAll(".controls input").on("change", function() {
  d3.select("#message").text("");
  setMode(this.value);
});

d3.select("#import").on("click", function() {
  try {
    var json = d3.select("#json").property("value");
    lib.fromJSON(json).render();
    setMode("test");
  } catch (err) {
    alert(err);
  }
});

d3.select("#download").on("click", function() {
  try {
    var json = d3.select("#json").property("value");
    download("gestures.json", json);
  } catch (err) {
    alert(err);
  }
});

function download(filename, text) {
  var a = document.createElement("a");
  a.setAttribute("href", "data:text/plain;charset=utf-8," + encodeURIComponent(text));
  a.setAttribute("download", filename);
  a.click();
}

// ---

var lib = new GestureLibrary(d3.select("#library").node())
  .addEntry()
  .render();

var points = null;
var basetime = null;

var canvas = d3.select("#canvas").node();
var width = canvas.width;
var height = canvas.height;

function getXY(evt) {
  var rect = canvas.getBoundingClientRect();
  if (evt.changedTouches) {
    evt = evt.changedTouches[0];
  }
  return {
    x: evt.pageX - rect.left,
    y: evt.pageY - rect.top
  };
}

function point() {
  var p = getXY(d3.event);
  var t = Date.now() - basetime;
  return new protractor.GesturePoint(p.x/width, p.y/height, t);
}

function strokeStart() {
  if (mode === "export") return false;
  basetime = Date.now();
  points = [point()];
  GestureLibrary.drawPoints(canvas, points);
  return true;
}

function strokeMove() {
  points.push(point());
  GestureLibrary.drawPoints(canvas, points);
}

function strokeEnd() {
  var strokes = [new protractor.GestureStroke(normalize(points))];
  var gesture = new protractor.Gesture(strokes);
  
  if (mode === "train") {
    lib.addGesture(gesture).render();
  } else {
    var r = lib.recognize(gesture), msg = "None!";
    if (r.length && r[0].score > THRESHOLD) {
      msg = r[0].name + " (" + r[0].score.toFixed(2) + ")";
    }
    d3.select("#message").text("RECOGNIZE: " + msg);
  }
  basetime = null;
  points = null;
  canvas.getContext("2d").clearRect(0, 0, width, height);
}

// ----

d3.select("#canvas")
  .on("touchstart", function() {
    if (strokeStart()) {
      d3.select(window).on("touchmove", move).on("touchend", touchend);
    }
  })
  .on("mousedown", function() {
    if (strokeStart()) {
      d3.select(window).on("mousemove", move).on("mouseup", mouseup);
    }
  });

function move() {
  d3.event.preventDefault();
  strokeMove();
}

function touchend() {
  d3.event.preventDefault();
  strokeEnd();
  d3.select(window).on("touchmove", null).on("touchend", null);
}

function mouseup() {
  d3.event.preventDefault();
  strokeEnd();
  d3.select(window).on("mousemove", null).on("mouseup", null);
}

// ---

function normalize(points) {
  var xmin = Number.MAX_VALUE,
      ymin = Number.MAX_VALUE,
      xmax = 0,
      ymax = 0,
      len = points.length, i, dx, dy;
  
  for (i=0; i<len; ++i) {
    if (points[i].x < xmin) xmin = points[i].x;
    if (points[i].y < ymin) ymin = points[i].y;
    if (points[i].x > xmax) xmax = points[i].x;
    if (points[i].y > ymax) ymax = points[i].y;
  }

  dx = xmax - xmin;
  dy = ymax - ymin;
  if (dx > dy) {
    ymin -= (dx - dy) / 2;
    dy += (dx - dy);
  } else {
    xmin -= (dy - dx) / 2;
    dx += (dy - dx);
  }

  for (i=0; i<len; ++i) {
    points[i].x = 0.1 + 0.8 * (points[i].x - xmin) / dx;
    points[i].y = 0.1 + 0.8 * (points[i].y - ymin) / dy;
  }
  
  return points;
}
  </script>
</html>